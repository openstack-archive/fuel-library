# DELETION TASKS
#
- id: deletion_start
  type: stage

- id: deletion_end
  type: stage
  requires: [deletion_start]

- id: upload_provision_info_master
  type: upload_file
  version: 2.1.0
  role: ['master']
  requires: [deletion_start]
  required_for: [reconfigure_dhcpd]
  parameters:
    path: /var/lib/fuel/configs/{CLUSTER_ID}/provision.yaml
    timeout: 180
    data:
      #TODO: Replace dict($.items) to $ when LP1666913 is fixed
      yaql_exp: "($.provision.set('packages', $.provision.packages) + $.repo_setup + dict('output' => '/var/www/nailgun/targetimages') + dict($.items())).toYaml()"

- id: reconfigure_dhcpd
  type: puppet
  version: 2.1.0
  role: ['master']
  requires: [upload_provision_info_master]
  required_for: [node_reboot]
  parameters:
    puppet_manifest: /etc/puppet/modules/fuel/examples/provision.pp
    puppet_modules: /etc/puppet/modules
    timeout: 3600

- id: node_reboot
  type: reboot
  version: 2.1.0
  role: ['/.*/']
  requires: [reconfigure_dhcpd]
  required_for: [node_erase]
  parameters:
    timeout: 300

- id: node_erase
  type: erase_node
  version: 2.1.0
  role: ['/.*/']
  requires: [node_reboot]
  required_for: [deletion_end]
  parameters:
    timeout: 180
