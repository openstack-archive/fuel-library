# PROVISION TASKS
#
- id: provision_start
  type: stage

- id: provision_end
  type: stage
  requires: [provision_start]

- id: upload_provision_info_master
  type: upload_file
  version: 2.1.0
  role: ['master']
  requires: [provision_start]
  required_for: [build_deploy_image]
  parameters:
    path: /tmp/provision.yaml
    timeout: 180
    data:
      #TODO: Replace dict($.items) to $ when LP1666913 is fixed
      yaql_exp: "($.provision.set('packages', $.provision.packages) + $.repo_setup + dict('output' => '/var/www/nailgun/targetimages') + dict($.items())).toYaml()"

- id: generate_ironic_bootstrap_keys
  type: shell
  version: 2.1.0
  role: ['master']
  requires: [provision_start]
  required_for: [build_deploy_image]
  condition:
    yaql_exp: '$.ironic.enabled'
  parameters:
    cmd: sh /etc/puppet/modules/osnailyfacter/modular/astute/generate_keys.sh -i {CLUSTER_ID} -s 'ironic' -p /var/lib/fuel/keys/
    timeout: 180
    retries: 1

- id: build_deploy_image
  type: puppet
  version: 2.1.0
  role: ['master']
  requires: [upload_provision_info_master, generate_ironic_bootstrap_keys]
  required_for: [provision_end]
  parameters:
    puppet_manifest: /etc/puppet/modules/osnailyfacter/modular/provision/build_image.pp
    puppet_modules: /etc/puppet/modules
    timeout: 3600

- id: provision_master
  type: puppet
  version: 2.1.0
  role: ['master']
  requires: [upload_provision_info_master]
  required_for: [build_deploy_image]
  parameters:
    puppet_manifest: /etc/puppet/modules/fuel/examples/provision.pp
    puppet_modules: /etc/puppet/modules
    timeout: 3600

- id: upload_provision_info
  type: upload_file
  version: 2.1.0
  role: ['/.*/']
  requires: [provision_master]
  required_for: [system_provision]
  parameters:
    path: /tmp/provision.json
    timeout: 180
    data:
      yaql_exp: '$.provision.toJson()'

- id: system_provision
  type: shell
  version: 2.1.0
  role: ['/.*/']
  requires: [provision_master, upload_provision_info]
  required_for: [node_reboot]
  cross-depends:
    - name: build_deploy_image
      role: master
  parameters:
    cmd: /usr/bin/provision
    timeout: 3600

- id: node_reboot
  type: reboot
  version: 2.1.0
  role: ['/.*/']
  requires: [cobbler_disable_netboot]
  required_for: [set_status_provisioned]
  parameters:
    timeout: 180
