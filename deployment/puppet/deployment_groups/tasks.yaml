#STAGES
- id: deploy
  type: stage

#GROUPS
- id: primary-controller
  type: group
  role: [primary-controller]
  required_for: [deploy]
  parameters:
    strategy:
      type: one_by_one
- id: controller
  type: group
  role: [controller]
  requires: [primary-controller]
  required_for: [deploy]
  parameters:
    strategy:
      type: parallel
      amount: 6
- id: cinder
  type: group
  role: [cinder]
  requires: [controller]
  required_for: [deploy]
  parameters:
    strategy:
      type: parallel
- id: compute
  type: group
  role: [compute]
  requires: [controller]
  required_for: [deploy]
  parameters:
    strategy:
      type: parallel
- id: zabbix-server
  type: group
  role: [zabbix-server]
  required_for: [deploy]
  parameters:
    strategy:
      type: one_by_one
- id: mongo
  type: group
  role: [mongo]
  requires: [zabbix-server]
  required_for: [deploy, primary-controller, controller]
  parameters:
    strategy:
      type: parallel
- id: primary-mongo
  type: group
  role: [primary-mongo]
  requires: [mongo]
  required_for: [deploy, primary-controller, controller]
  parameters:
    strategy:
      type: one_by_one
- id: ceph-osd
  type: group
  role: [ceph-osd]
  requires: [controller]
  required_for: [deploy]
  parameters:
    strategy:
      type: parallel
- id: base-os
  type: group
  role: [base-os]
  required_for: [deploy]
  parameters:
    strategy:
      type: parallel

#PREDEPLOYMENT HOOKS
- id: rsync_keys
  type: sync
  role: '*'
  stage: pre_deployment
  requires: [generate_keys]
  parameters:
    src: root@{MASTER_IP}:/etc/fuel/keys/{CLUSTER_ID}/
    dst: /var/lib/astute
    timeout: 180
- id: generate_keys
  type: shell
  role: ‘master’
  stage: pre_deployment
  required_for: [rsync_keys]
  parameters:
    cmd: sh /etc/puppet/modules/osnailyfacter/modular/generate_keys.sh -i {CLUSTER_ID} -o 'mongodb' -s 'neutron nova ceph mysql' -p /etc/fuel/keys/
    timeout: 180
