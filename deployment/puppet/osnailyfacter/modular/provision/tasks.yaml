# PROVISION TASKS
#
- id: upload_common_provision_info
  type: upload_file
  version: 2.1.0
  role: ['master']
  requires: [provision_start]
  required_for: [build_upload_image]
  parameters:
    path: /tmp/provision.json
    timeout: 180
    data:
      yaql_exp: '$.toJson()'

- id: copy_provision_info
  type: copy_files
  version: 2.1.0
  role: ['/.*/']
  required_for: [system_provision]
  requires: [upload_common_provision_info]
  parameters:
    files:
      - src: /tmp/provision.json
        dst: /tmp/provision.json
    permissions: '0600'
    dir_permissions: '0700'

- id: generate_ironic_bootstrap_keys
  type: shell
  version: 2.1.0
  role: ['master']
  requires: [provision_start]
  required_for: [provision_end]
  condition:
    yaql_exp: '$.ironic.enabled'
  parameters:
    cmd: sh /etc/puppet/modules/osnailyfacter/modular/astute/generate_keys.sh -i {CLUSTER_ID} -s 'ironic' -p /var/lib/fuel/keys/
    timeout: 180
    retries: 1

- id: build_deploy_image
  type: puppet
  version: 2.1.0
  role: ['master']
  requires: [upload_provision_info, generate_ironic_bootstrap_keys]
  required_for: [provision_end]
  parameters:
    puppet_manifest: /etc/puppet/modules/osnailyfacter/modular/provision/build_image.pp
    puppet_modules: /etc/puppet/modules
    timeout: 3600

- id: cobbler_enable_netboot
  type: master_shell
  version: 2.1.0
  role: ['/.*/']
  requires: [build_deploy_image]
  required_for: [move_to_bootstrap]
  parameters:
    cmd:
      yaql_exp: 'concat("sh /etc/puppet/modules/osnailyfacter/modular/provision/netboot enable ", $.network_metadata.nodes.values().where($.uid = new($.uid)).name.first())'
    timeout: 180

- id: move_to_bootstrap
  type: move_to_bootstrap
  version: 2.1.0
  role: ['/.*/']
  requires: [cobbler_enable_netboot]
  required_for: [system_provision]
  parameters:
    slave_name:
      yaql_exp: '$.network_metadata.nodes.values().where($.uid = new($.uid)).name.first()'
    provision_info:
      yaql_exp: '$.toYaml()'
    timeout: 180

- id: system_provision
  type: shell
  version: 2.1.0
  role: ['/.*/']
  requires: [build_deploy_image]
  required_for: [cobbler_disable_netboot]
  parameters:
    cmd: /usr/bin/provision
    timeout: 3600

- id: cobbler_disable_netboot
  type: master_shell
  version: 2.1.0
  role: ['/.*/']
  requires: [system_provision]
  required_for: [node_reboot]
  parameters:
    cmd:
      yaql_exp: 'concat("sh /etc/puppet/modules/osnailyfacter/modular/provision/netboot disable ", $.network_metadata.nodes.values().where($.uid = new($.uid)).name.first())'
    timeout: 180

- id: node_reboot
  type: reboot
  version: 2.1.0
  role: ['/.*/']
  requires: [cobbler_disable_netboot]
  required_for: [provision_end]
  parameters:
    timeout: 180
