require 'rubygems'
require 'puppetlabs_spec_helper/rake_tasks'

task :lint => ['lint:lint', 'lint:hiera_array']

namespace :lint do
  PuppetLint::RakeTask.new :lint do |config|
    config.disable_checks = [
      'autoloader_layout',
      'class_parameter_defaults',
      'class_inherits_from_params_class',
      '80chars'
    ]
    config.fail_on_warnings = false
  end

  task :hiera_array do |t|
    Dir.glob('./**/*.pp') do |manifest|
      result = system("grep -q 'hiera_array(.*[A-Za-z]_roles.*)' #{manifest}")

      if result
        $stderr.puts "WARNING: potentially dangerous hiera_array call found in #{manifest}"
      end
    end
  end
end
