/etc/init.d/dpdk start

export DPDK_OPTS="--dpdk <% if @ovs_socket_dir %>-vhost_sock_dir <%= @ovs_socket_dir %> <% end %>-c <%= @ovs_core_mask %> -n <%= @ovs_memory_channels %> --socket-mem <%= @ovs_socket_mem %>"

<% if @ovs_socket_dir -%>
# LP 1546565
umask 0002
mkdir -p "<%= @ovs_socket_dir %>"
<% if @ovs_socket_dir_group -%>
chgrp "<%= @ovs_socket_dir_group %>" "<%= @ovs_socket_dir %>" || true
<% end -%>
chmod g+s "<%= @ovs_socket_dir %>"
<% end -%>

# LP 1507921
max_map_count="$(awk -v padding=65530 '{total+=$1}END{print total*2+padding}' /sys/devices/system/node/node*/hugepages/hugepages-*/nr_hugepages)"
sysctl -q vm.max_map_count=${max_map_count:-65530}
